# SMTP/s - 25,465,587

## **SMTP Information** <a id="basic-information"></a>

**SMTP \(Simple Mail Transfer Protocol\)** is a TCP/IP protocol used in **sending** and receiving **e-mail**. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

In other words, **users typically use** a program that uses **SMTP for sending e-mail** and either **POP3 or IMAP for receiving** e-mail. On Unix-based systems, **sendmail** is the most widely-used SMTP server for e-mail. A commercial package, Sendmail, includes a POP3 server. **Microsoft Exchange** includes an SMTP server and can also be set up to include POP3 support. From [here](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol).

**Default port:** 25,465\(ssl\),587\(ssl\)

```text
PORT   STATE SERVICE REASON  VERSION25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```

### EMAIL Headers <a id="email-headers"></a>

If you have the opportunity to **make the victim send you an emai**l, do it because **you could learn about the internal network topology** of the victim seeing the headers of the mail.

You can also get an email from an SMTP server trying to **send to that server an email to a non-existent address** \(because the server will send to the attacker an NDN mail\). But, be sure that you send the email from an allowed address \(check the SPF policy\) and that you can receive NDN messages.

You should also try to **send different contents because you can find more interesting information** on the headers like: `X-Virus-Scanned: by av.domain.com` You should send the EICAR test file. Detecting the **AV** may allow you to exploit **known vulnerabilities.**

## Basic actions <a id="basic-actions"></a>

### **Banner Grabbing/Basic connection** <a id="banner-grabbing-basic-connection"></a>

**SMTP:**

```text
nc -vn <IP> 25
```

**SMTPS**:

SSL/TLS without **starttls** command

```text
openssl s_client -crlf -connect smtp.mailgun.org:465 
```

SSL/TLS with **starttls** command:

```text
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

### Finding MX servers of an organization <a id="finding-mx-servers-of-an-organisation"></a>

```text
dig +short mx google.com
```

### Enumeration <a id="enumeration"></a>

```text
nmap -p25 --script smtp-commands 10.10.10.10
```

### NTLM Authentication - Information Disclosure <a id="ntlm-auth-information-disclosure"></a>

If the server supports NTLM authentication \(Windows\) you can obtain sensitive information like \versions. More info [**here**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).

```text
username@kali: telnet example.com 587 
220 example.com SMTP Server Banner 
>> HELO 
250 example.com Hello [x.x.x.x] 
>> AUTH NTLM 334 
NTLM supported 
```

**This can be automated with** this with **nmap** plugin `smtp-ntlm-info.nse`

### Sniffing <a id="sniffing"></a>

Check if you sniff some passwords from the packets to port 25​

## Username Bruteforce Enumeration <a id="username-bruteforce-enumeration"></a>

**Authentication is not always needed**

### RCPT TO <a id="rcpt-to"></a>

We can use the **RCP TO** command to enumerate valid users:

```text
$ telnet 10.0.10.10 25
Trying 10.0.10.10...
Connected to 10.0.10.10.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:wixnic
250 2.1.5 wixnic... Recipient ok
```

### VRFY <a id="vrfy"></a>

We can also use the **VRFY** command to enumerate valid users:

```text
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```

### EXPN <a id="expn"></a>

Alternatively, we could use the **EXPN** command to enumerate valid users:

```text
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```

Extracted from: [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)​

## DSN Reports <a id="dsn-reports"></a>

**Delivery Status Notification Reports**: If you send an **email** to an organization to an **invalid address**, the organization will notify that the address was invalided by sending a **mail back to you**. **Headers** of the returned email will **contain** possible **sensitive information.**

## Sending an Email from a Linux console

### sendmail

```bash
sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:  
- First line must be received within 60 seconds.  
- End manual input with a CTRL-D on its own line.

​IT Dept,​

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

​Sincerely,
```

### swaks

```bash
 swaks --to $(cat emails.txt | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```

### \*\*\*\* <a id="what-about-subdomains"></a>

