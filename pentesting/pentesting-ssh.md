# Pentesting SSH - 22

## SSH Information

The Secure Shell Protocol is a cryptographic network protocol for operating network services securely over an unsecured network. Typical applications include remote command-line, login, and remote command execution, but any network service can be secured with SSH.

**Default Port:** 22 \(can be easily changed\)

**SSH Services:**

* \*\*\*\*[openSSH](http://www.openssh.org/) – OpenBSD SSH, shipped in BSD, Linux distributions and Windows since Windows 10.
* [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/) – SSH implementation for Windows.
* [CopSSH](https://www.itefix.net/copssh) – implementation of OpenSSH for Windows.

## SSH Enumeration

### Banner Grabbing

```text
nc -nv 10.10.10.10 22
```

### Weak Cipher Algorithms

Not all cipher algorithms are strong, nmap has a few scripts that enumerate this information:

```bash
nmap -p22 <ip> --script ssh2-enum-algos # Retrieve supported algorythms 
nmap -p22 <ip> --script ssh-hostkey --script-args ssh_hostkey=full # Retrieve weak keys
nmap -p22 <ip> --script ssh-auth-methods --script-args="ssh.user=root" # Check authentication methods
```

## SSH Authentication

We can authenticate to default port by using `ssh` command:

```text
ssh <target_username>@<target_IP>
```

We can authenticate to a specific port with `-p` option:

```text
ssh <target_username>@<target_IP> -p <target_port>
```

## SSH Keys

### Public Key

First, enumerate if the server accepts public keys:

```text
https://nmap.org/nsedoc/scripts/ssh-publickey-acceptance.html
```

We can scan public keys with:

```text
ssh-keyscan -t rsa <IP> <PORT>
```

### Private Key

If we have an authorized private key then we can authenticate to the server.

First we must ensure that the correct permissions are in place with:

```text
chmod 600 id_rsa
```

Then we can authenticate to the server with:

```
ssh -i id_rsa <target_username>@<target_IP>
```

## SSH Brute force

### hydra <a id="hydra"></a>

We can use hydra to bruteforce ssh:

```text
hydra -L <username_wordlist> -P <password_wordlist> ssh://<IP>
hydra -l username -P wordlist.txt ssh://127.0.0.1
hydra -L usernames.txt -P passwords.txt -s 2222 ssh://10.10.10.66 -v -t 4
```

### patator <a id="patator"></a>

We can use [patator](https://github.com/lanjelot/patator) as well:

```text
patator ssh_login host=<target_ip> port=<port> user=username password=FILE0 0=/usr/share/seclists/Passwords/probable-v2-top1575.txt persistent=0 -x ignore:mesg='Authentication failed'
patator ssh_login host=<target_ip> port=22022 password=FILE0 0=/opt/SecLists/Passwords/probabable-v2-top1575.txt persistent=0
```

### ncrack <a id="ncrack"></a>

ncrack can be use too:

```text
ncrack -p 22 --user root -P passwords.txt <IP> [-T 5]
```

### medusa <a id="medusa"></a>

medusa is another common tools that's used:

```text
medusa -h <target_ip> -U <users_wordlist.txt> -P <passwords.txt> -M ssh <target_ip>
```

## SSH and Kerberos

We can use the SSH protocol and authenticate with Kerberos.

### krb5

We can use krb5 for user authentication with krb5-user:

```text
sudo apt install krb5-user
```

The default configuration is in **/etc/krb5.conf** and we need to add the target realm:

```text
[libdefaults]
  default_realm = REALCORP.HTB

[realms]
  REALCORP.HTB = {
    kdc = realcorp.htb:88
    }
```

Before getting a ticket, we should check our time offset with:

```text
ntpdate -q 10.10.10.224
```

 Then we will need to synchronize our time with the server \(target\) time with:

```text
sudo rdate -n 10.10.10.224
```

 The command to get a ticket is `kinit`.

```text
user@hostname$ kinit j.nakazawa
Password for j.nakazawa@REALCORP.HTB: 
```

On entering the password above, it just returns without a message, which is good \(entering a bad password throws an error\). Running `klist` shows there’s a ticket on my system:

```text
user@hostname$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: j.nakazawa@REALCORP.HTB

Valid starting       Expires              Service principal
06/09/2021 07:29:18  06/10/2021 07:26:17  krbtgt/REALCORP.HTB@REALCORP.HTB
```

Kerberos can be very picky about DNS names. You need to make sure that your name resolution file is in order that Kerberos will accept:

```text
/etc/hosts
```

SSH in debugging mode to check for errors \(if any\):

```text
 ssh j.nakazawa@10.10.10.224 -vv
```

### crackmapexec 

**crackmapexec** using the `ssh` protocol can use the option `--kerberos` to **authenticate via kerberos**.  
For more info run `crackmapexec ssh --help`.













